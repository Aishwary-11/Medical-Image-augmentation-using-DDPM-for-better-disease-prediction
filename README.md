# Chest X-ray Synthesis and Pneumonia Classification

## 1. Project Overview

This project demonstrates an end-to-end deep learning pipeline for medical imaging. It consists of two main components:

1.  **Denoising Diffusion Probabilistic Model (DDPM):** A generative model trained on the NIH Chest X-ray dataset to synthesize new, realistic grayscale X-ray images.
2.  **Pneumonia Classifier:** A deep learning classifier (based on ResNet-50) trained to distinguish between 'NORMAL' and 'PNEUMONIA' chest X-rays. The training data can be augmented with the synthetic images generated by the DDPM.

The project is structured for modularity and reproducibility, separating concerns like data loading, model architecture, training, and inference.

## 2. Features

-   **Generative Model (DDPM):**
    -   U-Net architecture with sinusoidal time embeddings.
    -   Trained on a large-scale X-ray dataset to generate 256x256 grayscale images.
    -   Saves training checkpoints and generates sample images at specified intervals.
-   **Classification Model:**
    -   Transfer learning using a pre-trained ResNet-50 backbone.
    -   Handles class imbalance using weighted Cross-Entropy Loss.
    -   Optionally includes DDPM-generated images in the training set for data augmentation.
    -   Saves the best model based on validation accuracy.
-   **Evaluation & Reporting:**
    -   Generates and saves training/validation loss and accuracy plots.
    -   Produces a confusion matrix to evaluate the final classifier performance on the test set.
    -   Provides detailed metrics including accuracy, precision, recall, and F1-score.

## 3. Project Structure

```
.
├── data/                    # (Not tracked by Git)
├── notebooks/
├── src/
│   ├── config.py            # Central configuration
│   ├── data_loader.py       # Datasets and DataLoaders
│   ├── models/              # Model architectures (DDPM, Classifier)
│   ├── train_ddpm.py        # Script to train the generative model
│   ├── train_classifier.py  # Script to train the classifier
│   ├── generate_images.py   # Script to generate synthetic images
│   └── utils.py             # Helper functions for plotting/evaluation
├── models_trained/          # (Not tracked by Git) Stores trained models
├── generated_images/        # (Not tracked by Git) Stores synthetic images
├── reports/                 # (Not tracked by Git) Stores plots and metrics
├── .gitignore
├── requirements.txt
└── README.md
```

## 4. Getting Started

### Prerequisites

-   Python 3.8+
-   NVIDIA GPU with CUDA support (recommended for reasonable training times)
-   `pip` (Python package installer)

### Installation

1.  **Clone the repository:**
    ```bash
    git clone <your-repository-url>
    cd chest-xray-synthesis-and-classification
    ```

2.  **Create and activate a virtual environment:**
    ```bash
    python3 -m venv venv
    source venv/bin/activate  # On Windows: .\venv\Scripts\activate
    ```

3.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Set up the dataset:**
    -   Download the NIH Chest X-ray or a similar dataset.
    -   Organize it according to the paths specified in `src/config.py`. The DDPM expects a parent directory containing `train_val_list.txt` and subdirectories for the images. The classifier expects `train/`, `val/`, and `test/` directories, each containing `NORMAL/` and `PNEUMONIA/` subfolders.
    -   **Update the paths in `src/config.py` to match your local setup.**

## 5. Usage

The project follows a three-step workflow.

### Step 1: Train the DDPM to Generate Images

First, train the generative model. This will create a `models_trained/ddpm_checkpoints` directory and a `generated_images/` directory.

```bash
python src/train_ddpm.py
```

This process can be time-consuming. It will periodically save model checkpoints and sample images.

### Step 2: Generate a Final Synthetic Image

Once the DDPM is trained, use the generation script to create a final synthetic image that will be used for augmenting the classifier's training data.

```bash
# This script uses the latest checkpoint by default
python src/generate_images.py
```
This will save `final_generated_image.png` in the `generated_images/` directory.

### Step 3: Train the Pneumonia Classifier

Finally, train the classifier. This script will automatically look for the synthetic image generated in the previous step and include it in the training data.

```bash
python src/train_classifier.py
```
After training, this script will:
- Save the best model to `models_trained/best_pneumonia_classifier.pth`.
- Generate training history plots and a final confusion matrix in the `reports/` directory.

## 6. Configuration

All important parameters, such as file paths, batch sizes, epochs, and learning rates, can be adjusted in `src/config.py`. This centralized file makes it easy to experiment with different settings without modifying the core logic.

## 7. License

This project is licensed under the MIT License.
